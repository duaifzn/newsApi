<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Search JSON API</title>
  </head>
  <body>
    <h1>Custom Search JSON API</h1>
    <label for="keyword">input keyword:</label>
    <input type="text" id="keyword" name="keyword" /><br /><br />
    <button type="button" onclick="clean()">Clean</button>
    <button type="button" onclick="search()">Search</button><br /><br />
    <textarea id="content" rows="10" cols="100">
    </textarea><br /><br />
    <button type="button" onclick="download()">download csv</button><br /><br />
    <div id="link"></div>
    <script src="./assets/js/moment.js"></script>
    <script src="./assets/js/sources.js"></script>
    <script>
      clean();
      const key = '<%=process.env.key %>';
      const searchEngine1 = '<%=process.env.cx %>';
      const searchEngine2 = '<%=process.env.cx2 %>';
      const searchEngine3 = '<%=process.env.cx3 %>';
      const searchEngine4 = '<%=process.env.cx4 %>';
      const searchEngine5 = '<%=process.env.cx5 %>';
      const searchEngine6 = '<%=process.env.cx6 %>';
      const searchEngine7 = '<%=process.env.cx7 %>';
      const searchEngine8 = '<%=process.env.cx8 %>';
      const searchEngine9 = '<%=process.env.cx9 %>';
      function json2csv(res) {
        if(!res.items) return
        for (const item of res.items) {
          try{
            let temp = item.pagemap.metatags[0]['article:published_time']
          }catch(err){
            continue
          }
          let publishTime = moment(item.pagemap.metatags[0]['article:published_time'], 'YYYY-MM-DD')
          if(moment().diff(publishTime, 'days') > 1) { continue }
          content.innerHTML +=  moment().subtract(1, 'days').format('yyyy/MM/DD') + ',';
          content.innerHTML += sources[item.displayLink]?sources[item.displayLink]:item.displayLink;
          content.innerHTML += ',';
          content.innerHTML +=
            item.htmlTitle.replace('<b>', '').replace('</b>', '') + ',';
          content.innerHTML += item.link + '\r\n';
        }
      }
      function download() {
        let title = document.getElementById('keyword').value;
        const date = moment().format('yyyyMMDD');
        let csv = document.getElementById('content').value;
        let uri = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURI(csv);
        let link = document.createElement('A');
        link.href = uri;
        link.download = date + '_' + title + '.csv';
        link.click();
      }

      function clean() {
        let content = document.getElementById('content');
        content.innerHTML = '時間,來源,標題,連結\r\n';
        document.getElementById('keyword').value = '';
      }

      async function search() {
        if(document.getElementById('keyword').value.trim() == '') {
            alert('keyword need value!!')
            return
        }
        await searchEngine(searchEngine1, 1)
        await searchEngine(searchEngine2, 1)
        await searchEngine(searchEngine3, 1)
        await searchEngine(searchEngine4, 1)
        await searchEngine(searchEngine5, 1)
        await searchEngine(searchEngine6, 1)
        await searchEngine(searchEngine7, 1)
        await searchEngine(searchEngine8, 1)
        await searchEngine(searchEngine9, 1)
      }
      async function searchEngine(cx, startIndex){
        const query = document.getElementById('keyword').value;
        const fromDate = moment().format('yyyyMMDD');
        const toDate = moment().subtract(1, 'days').format('yyyyMMDD');
        const res = await fetch(
          `https://www.googleapis.com/customsearch/v1/siterestrict?key=${key}&cx=${cx}&q=${query}&start=${startIndex}&sort=date:r:${toDate}:${toDate}`,
        )
        const data = await res.json()
        json2csv(data);
        if(data.queries){
            if (data.queries.nextPage) {
                await searchEngine(cx, data.queries.nextPage[0].startIndex);
            }
        }
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Search JSON API</title>
  </head>
  <body>
    <h1>Custom Search JSON API</h1>
    <label for="keyword">input keyword:</label>
    <input type="text" id="keyword" name="keyword" /><br /><br />
    <button type="button" onclick="clean()">Clean</button>
    <button type="button" onclick="search()">Search</button><br /><br />
    <textarea id="content" rows="10" cols="100">
    </textarea><br /><br />
    <button type="button" onclick="download()">download csv</button><br /><br />
    <div id="link"></div>
    <script src="./assets/js/moment.js"></script>
    <script>
      clean();
      const key = '<%=process.env.key %>';
      const searchEngine1 = '<%=process.env.cx %>';
      const searchEngine2 = '<%=process.env.cx2 %>';
      const searchEngine3 = '<%=process.env.cx3 %>';
      const searchEngine4 = '<%=process.env.cx4 %>';
      const searchEngine5 = '<%=process.env.cx5 %>';
      const searchEngine6 = '<%=process.env.cx6 %>';
      const sources = {
        'www.gvm.com.tw': '遠見雜誌',
        'news.tvbs.com.tw': 'TVBS新聞網',
        'www.mirrormedia.mg': '鏡週刊',
        'www.storm.mg': '風傳媒',
        'heho.com.tw': 'Heho健康',
        'money.udn.com': '經濟日報',
        'www.nownews.com': 'NOWnews今日新聞',
        'www.chinatimes.com': '中時新聞網',
        'www.ettoday.net': 'ETtoday新聞雲',
        'udn.com': '聯合新聞網',
        'tyenews.com': '桃園電子報',
        'www.setn.com': '三立新聞網',
        'www.ltn.com.tw': '自由時報電子報',
        'newtalk.tw': '新頭殼',
        'tw.news.yahoo.com': 'Yahoo奇摩新聞',
        'www.cna.com.tw': '中央社',
        'www.gamer.com.tw': '巴哈姆特',
        'www.aspn.media': 'ASPN',
        'm.match.net.tw': 'match生活網',
        'disp.cc': 'BBS',
        'www.bomb01.com': 'bomb01',
        'cnews.com.tw':'匯流新聞網',
        'www.ctwant.com':'ctwant',
        'www.dailymotion.com':'dailymotion',
        'www.dcard.tw':'dcard',
        'www.youtube.com':'youtube',
        'rec.org.tw':'eTV傳媒',
        'zh-tw.facebook.com':'facebook',
        'fongnews.net':'溏風報',
        'www.hinet.net':'hinet',
        'times.hinet.net': 'Hinet生活誌',
        'life.tw': 'LIFE',
        'today.line.me': 'LINE TODAY',
        'ww2.money-link.com.tw': 'MONEY LINK 富聯網',  
        'moptt.tw': 'MOPPT鄉公所',
        'www.msn.com': 'msn新聞',
        'news.pchome.com.tw': 'PChome新聞',
        'news.sina.com.tw': 'sina新浪新聞',
        'www.thenewslens.com': 'The News Lens',
        'news.tvbs.com.tw': 'TVBS',
        'tvtw.live': 'TvTw',
        'yimedia.com.tw': 'YI 毅傳媒',
        'www.merit-times.com': '人間福報',
        'www.upmedia.mg': '上報',
        'www.epochtimes.com': '大紀元',
        'ctee.com.tw': '工商時報',
        'www.rti.org.tw': '中央廣播電台',
        'www.cdns.com.tw': '中華新聞雲',
        'new.ctv.com.tw': '中視新聞',
        'www.bcc.com.tw': '中廣新聞網',
        'www.npa.gov.tw': '內政部警政署',
        'news.pts.org.tw': '公視新聞網',
        'daynews.cc': '天天要聞',
        'www.bastillepost.com': '巴士的報',
        'www.worldjournal.com': '世界新聞網',
        'news.ttv.com.tw': '台視新聞網',
        'www.taiwanjustice.net':  '台灣公義報',
        'www.taiwanhot.net': '台灣好新聞',
        'www.tssdnews.com.tw': '台灣新生報',
        'www.5ch.com.tw': '台灣新聞網',
        'www.ftvnews.com.tw': '民視新聞網',
      }
      function json2csv(res) {
        if(!res.items) return
        for (const item of res.items) {
          content.innerHTML +=  moment().subtract(1, 'days').format('yyyy/MM/DD') + ',';
          content.innerHTML += sources[item.displayLink]?sources[item.displayLink]:item.displayLink;
          content.innerHTML += ',';
          content.innerHTML +=
            item.htmlTitle.replace('<b>', '').replace('</b>', '') + ',';
          content.innerHTML += item.link + '\r\n';
        }
      }
      function download() {
        let csv = document.getElementById('content').value;
        let uri = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURI(csv);
        let link = document.createElement('A');
        link.href = uri;
        link.download = 'test' + '.csv';
        link.click();
      }

      function clean() {
        let content = document.getElementById('content');
        content.innerHTML = '時間,來源,標題,連結\r\n';
        document.getElementById('keyword').value = '';
      }

      async function search() {
        await searchEngine(searchEngine1, 1)
        await searchEngine(searchEngine2, 1)
        await searchEngine(searchEngine3, 1)
        await searchEngine(searchEngine4, 1)
        await searchEngine(searchEngine5, 1)
        await searchEngine(searchEngine6, 1)
      }
      async function searchEngine(cx, startIndex){
        const query = document.getElementById('keyword').value;
        const fromDate = moment().format('yyyyMMDD');
        const toDate = moment().subtract(1, 'days').format('yyyyMMDD');
        const res = await fetch(
          `https://www.googleapis.com/customsearch/v1/?key=${key}&cx=${cx}&q=${query}&start=${startIndex}&sort=date:r:${toDate}:${toDate}`,
        )
        const data = await res.json()
        json2csv(data);
        if(data.queries){
            if (data.queries.nextPage) {
                await searchEngine(cx, data.queries.nextPage[0].startIndex);
            }
        }
      }
    </script>
  </body>
</html>
